name: MLFlow and Snakemake Workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  MLFLOW_URL: https://4af2-160-176-233-39.ngrok-free.app

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - name: Set up virtual environment and install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install mlflow prometheus_client snakemake pulp==2.7.0 jq
        shell: bash

      - name: Create a new run in MLFlow
        run: |
          echo "üì° Cr√©ation d'un nouveau run dans MLFlow..."
          timestamp=$(date +%Y%m%d%H%M%S)
          start_time=$(date +%s000)
          response=$(curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"experiment_id\": \"0\", \"run_name\": \"GitHub_Run_$timestamp\", \"start_time\": $start_time}" \
            $MLFLOW_URL/api/2.0/mlflow/runs/create)
          run_id=$(echo $response | jq -r '.run.info.run_id')
          echo "‚úÖ Run cr√©√© avec l'ID: $run_id"
        shell: bash

      - name: Train the model and log metrics to MLFlow
        run: |
          source venv/bin/activate
          echo "üì° Entra√Ænement du mod√®le et log des m√©triques dans MLFlow..."
          
          # Exemple d'entra√Ænement d'un mod√®le (assurez-vous de remplacer cette section par votre code r√©el d'entra√Ænement)
          python train_model.py  # Ex√©cutez votre script d'entra√Ænement ici

          # Log des m√©triques
          for epoch in $(seq 1 10); do
            loss=$(python -c "import random; print(random.uniform(0, 1))")  # Remplacer par votre calcul de loss
            accuracy=$(python -c "import random; print(random.uniform(0, 1))")  # Remplacer par votre calcul de pr√©cision
            mlflow.log_metric("loss", $loss, step=$epoch)
            mlflow.log_metric("accuracy", $accuracy, step=$epoch)
            echo "üìä Enregistr√© loss=$loss et accuracy=$accuracy pour l'√©poque $epoch"
          done
        shell: bash

      - name: Start Prometheus PushGateway
        run: |
          docker run -d -p 9091:9091 prom/pushgateway
          sleep 5
        shell: bash

      - name: Fetch and push MLFlow metrics to Prometheus
        run: |
          source venv/bin/activate
          echo "üì° Interrogation de MLFlow..."
          response=$(curl -s -H "Content-Type: application/json" \
            -d '{"max_results": 100}' \
            "$MLFLOW_URL/api/2.0/mlflow/experiments/search")
          if echo "$response" | jq -e '.experiments != null and (.experiments | length > 0)' > /dev/null; then
            echo "‚úÖ R√©ponse valide de MLFlow :"
            echo "$response"
            experiments=$(echo "$response" | jq -r '.experiments[].experiment_id')
            for exp in $experiments; do
              echo "üîç Exp√©rience ID: $exp"
              runs=$(curl -s -H "Content-Type: application/json" \
                -d "{\"experiment_ids\": [\"$exp\"]}" \
                $MLFLOW_URL/api/2.0/mlflow/runs/search)
              if echo "$runs" | jq -e '.runs != null and (.runs | length > 0)' > /dev/null; then
                run_ids=$(echo "$runs" | jq -r '.runs[].info.run_id')
                for run in $run_ids; do
                  echo "üìä Analyse du run: $run"
                  metrics_response=$(curl -s "$MLFLOW_URL/api/2.0/mlflow/runs/get?run_id=$run")
                  if echo "$metrics_response" | jq -e '.run.data.metrics != null and (.run.data.metrics | length > 0)' > /dev/null; then
                    metrics=$(echo "$metrics_response" | jq -r '.run.data.metrics')
                    echo "$metrics" | jq -c 'to_entries[]' | while read -r metric_entry; do
                      raw_key=$(echo "$metric_entry" | jq -r '.key')
                      value=$(echo "$metric_entry" | jq -r '.value')
                      # Remplacement des caract√®res non alphanum√©riques
                      key=$(echo "$raw_key" | sed 's/[^a-zA-Z0-9_]/_/g' | sed 's/^__*//; s/__*$//' | tr -s '_')
                      # Validation du nom de la m√©trique
                      if [[ ! "$key" =~ ^[a-zA-Z_:][a-zA-Z0-9_:]*$ ]]; then
                        echo "‚ö†Ô∏è Nom de m√©trique invalide: '$key'. Il a √©t√© ignor√©."
                        continue
                      fi
                      echo "Nom de la m√©trique : $key"
                      echo "Valeur : $value"
                      echo "$key{experiment=\"$exp\",run=\"$run\"} $value" \
                        | curl --data-binary @- http://localhost:9091/metrics/job/mlflow_metrics
                    done
                  else
                    echo "‚ö†Ô∏è Aucune m√©trique trouv√©e pour le run $run."
                  fi
                done
              else
                echo "‚ö†Ô∏è Aucun run trouv√© pour l'exp√©rience $exp."
              fi
            done
          else
            echo "‚ùå Aucune exp√©rience trouv√©e dans MLFlow."
            echo "$response"
            exit 1
          fi
        shell: bash

      - name: Push global success metric to Prometheus
        run: |
          echo "success 1" | curl --data-binary @- http://127.0.0.1:9091/metrics/job/mlflow_metrics
        shell: bash

      - name: Check metrics in PushGateway
        run: |
          echo "V√©rification des m√©triques dans PushGateway..."
          if curl -s http://127.0.0.1:9091/metrics | grep -q 'success'; then
            echo "‚úÖ Les m√©triques sont pr√©sentes dans PushGateway."
          else
            echo "‚ùå Aucune m√©trique trouv√©e dans PushGateway."
          fi
        shell: bash

      - name: Complete Monitoring
        run: echo "‚úÖ Fin de l'ex√©cution, v√©rification via Grafana et Prometheus"
        shell: bash
