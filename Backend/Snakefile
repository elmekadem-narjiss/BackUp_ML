from pathlib import Path
import os
import yaml

# Charger la configuration
with open("config.yaml", "r") as f:
    config = yaml.safe_load(f)

# Règle pour vérifier la disponibilité des fichiers locaux nécessaires
rule check_requirements:
    output:
        "data/requirements_check.txt"
    run:
        # Vérifier si les fichiers d'authentification Google Drive existent
        required_files = ["client_secrets.json", "token.json"]
        missing_files = [f for f in required_files if not os.path.exists(f)]
        if missing_files:
            raise Exception(f"Fichiers manquants : {missing_files}")
        with open(output[0], "w") as f:
            f.write("Tous les fichiers nécessaires sont présents")

# Règle pour télécharger les données
rule download_data:
    input:
        "data/requirements_check.txt"
    output:
        "data/raw_data.csv"
    params:
        file_name=config["data"]["file_name"]
    shell:
        """
        python Backend/download_file.py --file-name {params.file_name} --output {output}
        """

# Règle pour entraîner le modèle
rule train_model:
    input:
        "data/raw_data.csv"
    output:
        "output/ppo_bess_model_metrics.json"
    shell:
        """
        source venv/bin/activate
        snakemake --cores 1 train_ppo
        """

# Règle principale
rule all:
    input:
        "output/ppo_bess_model_metrics.json"
